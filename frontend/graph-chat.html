<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ¥è¯†å›¾è°±æ„å»ºå™¨ - å›¾è°±æå–ä¸å¯¹è¯</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1em;
            opacity: 0.9;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            align-items: start;
        }

        .panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-height: calc(100vh - 150px);
            overflow-y: auto;
        }

        .panel-title {
            font-size: 1.3em;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* å·¦ä¾§é¢æ¿ - çŸ¥è¯†å›¾è°±æå– */
        .extraction-section {
            margin-bottom: 15px;
        }

        .section-title {
            font-size: 1.1em;
            color: #555;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
        }

        .form-group {
            margin-bottom: 10px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            color: #555;
            font-weight: 500;
            font-size: 13px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 13px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: inline-block;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-test {
            background: #28a745;
        }

        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .response-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 12px;
        }

        .response-area pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', monospace;
        }

        .response-success {
            background: #d4edda;
            border-color: #c3e6cb;
        }

        .response-error {
            background: #f8d7da;
            border-color: #f5c6cb;
        }

        .progress-bar {
            width: 100%;
            height: 25px;
            background: #f0f0f0;
            border-radius: 12px;
            overflow: hidden;
            margin: 10px 0;
            display: none;
        }

        .progress-bar.show {
            display: block;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 11px;
            font-weight: 500;
        }

        .file-drop-area {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: background 0.3s;
            margin-bottom: 10px;
        }

        .file-drop-area:hover {
            background: #f8f9ff;
        }

        .file-info {
            margin-top: 8px;
            padding: 8px;
            background: #f5f5f5;
            border-radius: 5px;
            display: none;
            font-size: 12px;
        }

        .file-info.show {
            display: block;
        }

        .hidden {
            display: none;
        }

        /* å³ä¾§é¢æ¿ - èŠå¤© */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 15px;
            min-height: 400px;
            max-height: 500px;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }

        .message.user {
            align-items: flex-end;
        }

        .message.assistant {
            align-items: flex-start;
        }

        .message-content {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.5;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message.assistant .message-content {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
        }

        .message.tool {
            align-items: flex-start;
        }

        .message.tool .message-content {
            background: transparent;
            border: none;
            padding: 5px 0;
            max-width: 100%;
        }

        .message-meta {
            font-size: 11px;
            color: #999;
            margin-top: 4px;
        }

        .tool-call, .tool-result {
            margin: 8px 0;
            border-radius: 6px;
            overflow: hidden;
        }

        .tool-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        .tool-call .tool-header {
            background: #fff3cd;
            border-left: 3px solid #ffc107;
        }

        .tool-result .tool-header {
            background: #d1ecf1;
            border-left: 3px solid #17a2b8;
        }

        .tool-header:hover {
            filter: brightness(0.95);
        }

        .tool-icon {
            font-size: 14px;
        }

        .tool-name {
            flex: 1;
            font-weight: 500;
            font-size: 13px;
        }

        .tool-toggle {
            font-size: 11px;
            color: #666;
        }

        .tool-details {
            padding: 0;
        }

        .tool-args, .tool-result-content {
            margin: 0;
            padding: 10px 12px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            font-size: 12px;
            font-family: 'Consolas', 'Monaco', monospace;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 400px;
            overflow-y: auto;
        }

        .tool-loading {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #e2e3e5;
            border-left: 3px solid #6c757d;
            border-radius: 4px;
            font-size: 12px;
            margin: 5px 0;
        }

        .loading-spinner {
            width: 12px;
            height: 12px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .chat-input-area {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .chat-model-select {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chat-model-select select {
            flex: 1;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
        }

        .chat-input-box {
            display: flex;
            gap: 10px;
        }

        .chat-input-box textarea {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            resize: none;
            font-family: inherit;
            font-size: 14px;
            min-height: 60px;
        }

        .chat-input-box textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .send-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: transform 0.2s;
        }

        .send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .typing-indicator {
            display: none;
            padding: 10px 15px;
            color: #999;
            font-size: 13px;
            font-style: italic;
        }

        .typing-indicator.show {
            display: block;
        }

        @media (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 1fr;
            }

            .panel {
                max-height: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§  çŸ¥è¯†å›¾è°±æ„å»ºå™¨</h1>
            <p>å›¾è°±æå–ä¸æ™ºèƒ½å¯¹è¯ç³»ç»Ÿ</p>
        </div>

        <div class="main-layout">
            <!-- å·¦ä¾§é¢æ¿ - çŸ¥è¯†å›¾è°±æå– -->
            <div class="panel">
                <div class="panel-title">
                    <span>ğŸ“Š çŸ¥è¯†å›¾è°±æå–</span>
                    <span id="extractionStatus" class="status-badge" style="font-size: 0.7em; padding: 4px 10px; border-radius: 10px; background: #e0e0e0;">å°±ç»ª</span>
                </div>

                <!-- æ•°æ®åº“è¿æ¥ -->
                <div class="extraction-section">
                    <div class="section-title">ğŸ”— æ•°æ®åº“è¿æ¥</div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>URI</label>
                            <input type="text" id="dbUri" placeholder="bolt://127.0.0.1:7687" value="bolt://127.0.0.1:7687">
                        </div>
                        <div class="form-group">
                            <label>ç”¨æˆ·å</label>
                            <input type="text" id="dbUsername" placeholder="neo4j" value="neo4j">
                        </div>
                        <div class="form-group">
                            <label>å¯†ç </label>
                            <input type="password" id="dbPassword" placeholder="å¯†ç " value="12345678">
                        </div>
                        <div class="form-group">
                            <label>æ•°æ®åº“</label>
                            <input type="text" id="dbDatabase" placeholder="neo4j" value="neo4j">
                        </div>
                    </div>
                    <div class="btn-group">
                        <button onclick="testConnection()" class="btn btn-small btn-test">æµ‹è¯•è¿æ¥</button>
                    </div>
                    <div id="connectionResponse" class="response-area hidden"></div>
                </div>

                <!-- æ–‡ä»¶ä¸Šä¼  -->
                <div class="extraction-section">
                    <div class="section-title">ğŸ“ æ–‡ä»¶ä¸Šä¼ </div>
                    <div class="form-group">
                        <label>é€‰æ‹©æ¨¡å‹</label>
                        <select id="modelSelect">
                            <option value="deepseek-deepseek-chat">DeepSeek Chat</option>
                            <option value="dashscope-qwen3-max">Qwen 3 Max</option>
                        </select>
                    </div>
                    <div class="file-drop-area" id="dropArea">
                        <p style="font-size: 1.1em; margin-bottom: 8px;">ğŸ“„</p>
                        <p style="font-size: 13px;">æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©</p>
                        <input type="file" id="fileInput" style="display: none;" accept=".pdf,.txt,.docx,.doc">
                    </div>
                    <div id="fileInfo" class="file-info">
                        <p><strong>æ–‡ä»¶å:</strong> <span id="fileName"></span></p>
                        <p><strong>æ–‡ä»¶å¤§å°:</strong> <span id="fileSize"></span></p>
                    </div>
                    <div class="progress-bar" id="uploadProgress">
                        <div class="progress-bar-fill" id="uploadProgressFill" style="width: 0%">0%</div>
                    </div>
                    <div class="btn-group">
                        <button onclick="uploadFile()" id="uploadBtn" class="btn btn-small" disabled>ä¸Šä¼ æ–‡ä»¶</button>
                        <button onclick="clearFile()" class="btn btn-small btn-secondary">æ¸…é™¤</button>
                    </div>
                    <div id="uploadResponse" class="response-area hidden"></div>
                </div>

                <!-- çŸ¥è¯†å›¾è°±æå– -->
                <div class="extraction-section">
                    <div class="section-title">âš—ï¸ å›¾è°±æå–</div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>æ¨¡å‹</label>
                            <select id="extractModel">
                                <option value="deepseek-deepseek-chat">DeepSeek Chat</option>
                                <option value="dashscope-qwen3-max">Qwen 3 Max</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>æ•°æ®æº</label>
                            <select id="sourceType" onchange="updateSourceFields()">
                                <option value="local_file">æœ¬åœ°æ–‡ä»¶</option>
                                <option value="web-url">ç½‘é¡µ URL</option>
                                <option value="bilibili">Bilibili</option>
                                <option value="Wikipedia">ç»´åŸºç™¾ç§‘</option>
                            </select>
                        </div>
                    </div>

                    <div id="localFileFields">
                        <div class="form-group">
                            <label>æ–‡ä»¶å</label>
                            <input type="text" id="fileName_extract" placeholder="ä»ä¸Šä¼ çš„æ–‡ä»¶ä¸­é€‰æ‹©">
                        </div>
                    </div>

                    <div id="urlFields" class="hidden">
                        <div class="form-group">
                            <label>URL åœ°å€</label>
                            <input type="url" id="sourceUrl" placeholder="https://example.com/article">
                        </div>
                    </div>

                    <div id="bilibiliFields" class="hidden">
                        <div class="form-group">
                            <label>Bilibili URL</label>
                            <input type="url" id="bilibiliUrl" placeholder="https://www.bilibili.com/video/BV...">
                        </div>
                    </div>

                    <div id="wikiFields" class="hidden">
                        <div class="form-group">
                            <label>ç»´åŸºç™¾ç§‘æœç´¢å…³é”®è¯</label>
                            <input type="text" id="wikiQuery" placeholder="ä¾‹å¦‚: Artificial Intelligence">
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>Token å—å¤§å°</label>
                            <input type="number" id="tokenChunkSize" value="10000" min="1000">
                        </div>
                        <div class="form-group">
                            <label>å—é‡å å¤§å°</label>
                            <input type="number" id="chunkOverlap" value="200" min="0">
                        </div>
                    </div>

                    <div class="btn-group">
                        <button onclick="extractGraph()" class="btn btn-small btn-test">æå–çŸ¥è¯†å›¾è°±</button>
                    </div>
                    <div id="extractResponse" class="response-area hidden"></div>
                </div>

                <!-- åå¤„ç†ä»»åŠ¡ -->
                <div class="extraction-section">
                    <div class="section-title">ğŸ”§ åå¤„ç†ä»»åŠ¡</div>
                    <div style="background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <label style="display: flex; align-items: center; font-size: 13px; cursor: pointer; padding: 6px; background: white; border-radius: 5px; border: 1px solid #e0e0e0; transition: all 0.2s;">
                                <input type="checkbox" id="task_similarities" value="materialize_text_chunk_similarities" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                <span>ğŸ“Š æ–‡æœ¬å—ç›¸ä¼¼æ€§è®¡ç®— (KNNå›¾)</span>
                            </label>
                            <label style="display: flex; align-items: center; font-size: 13px; cursor: pointer; padding: 6px; background: white; border-radius: 5px; border: 1px solid #e0e0e0; transition: all 0.2s;">
                                <input type="checkbox" id="task_fulltext" value="enable_fulltext_search" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                <span>ğŸ” å¯ç”¨å…¨æ–‡æœç´¢å’Œæ··åˆæœç´¢</span>
                            </label>
                            <label style="display: flex; align-items: center; font-size: 13px; cursor: pointer; padding: 6px; background: white; border-radius: 5px; border: 1px solid #e0e0e0; transition: all 0.2s;">
                                <input type="checkbox" id="task_consolidation" value="graph_schema_consolidation" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                <span>ğŸ”„ å›¾è°±æ¨¡å¼æ•´åˆï¼ˆèŠ‚ç‚¹å…³ç³»ä¼˜åŒ–ï¼‰</span>
                            </label>
                        </div>
                    </div>
                    <div class="btn-group" style="margin-top: 12px;">
                        <button onclick="executePostProcessing()" class="btn btn-small" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">âš¡ æ‰§è¡Œåå¤„ç†</button>
                        <button onclick="selectAllTasks()" class="btn btn-small btn-secondary">â˜‘ï¸ å…¨é€‰</button>
                        <button onclick="clearTaskSelection()" class="btn btn-small btn-secondary">ğŸ—‘ï¸ æ¸…ç©º</button>
                    </div>
                    <div id="postProcessingResponse" class="response-area hidden"></div>
                </div>
            </div>

            <!-- å³ä¾§é¢æ¿ - èŠå¤©å¯¹è¯ -->
            <div class="panel">
                <div class="panel-title">
                    <span>ğŸ’¬ æ™ºèƒ½å¯¹è¯</span>
                    <button onclick="clearChat()" class="btn btn-small btn-secondary" style="padding: 4px 10px; font-size: 12px;">æ¸…ç©ºå¯¹è¯</button>
                </div>

                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        <div class="message assistant">
                            <div class="message-content">
                                ä½ å¥½ï¼æˆ‘æ˜¯åŸºäºçŸ¥è¯†å›¾è°±çš„æ™ºèƒ½åŠ©æ‰‹ã€‚è¯·å…ˆåœ¨å·¦ä¾§ä¸Šä¼ æ–‡æ¡£å¹¶æå–çŸ¥è¯†å›¾è°±ï¼Œç„¶åå°±å¯ä»¥å‘æˆ‘æé—®äº†ï¼ğŸš€
                            </div>
                        </div>
                    </div>

                    <div class="typing-indicator" id="typingIndicator">
                        ğŸ¤– æ­£åœ¨æ€è€ƒä¸­...
                    </div>

                    <div class="chat-input-area">
                        <div class="chat-model-select">
                            <label style="font-size: 13px; font-weight: 500; color: #555;">é€‰æ‹©æ¨¡å‹:</label>
                            <select id="chatModel">
                                <option value="deepseek-deepseek-chat">DeepSeek Chat</option>
                                <option value="dashscope-qwen3-max">Qwen 3 Max</option>
                            </select>
                        </div>

                        <div class="chat-model-select">
                            <label style="font-size: 13px; font-weight: 500; color: #555;">èŠå¤©æ¨¡å¼:</label>
                            <select id="chatMode">
                                <option value="generate_cypher">Generate Cypher (Cypher ç”Ÿæˆ)</option>
                                <option value="graph_retrieve">Graph Retrieve (å›¾æ£€ç´¢)</option>
                            </select>
                        </div>

                        <div class="chat-input-box">
                            <textarea id="chatInput" placeholder="è¾“å…¥ä½ çš„é—®é¢˜... ä¾‹å¦‚ï¼šè¿™ä¸ªæ–‡æ¡£ä¸»è¦è®²äº†ä»€ä¹ˆå†…å®¹ï¼Ÿ" onkeypress="handleChatKeyPress(event)"></textarea>
                            <button onclick="sendMessage()" class="send-btn" id="sendBtn">å‘é€</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:7860';
        let selectedFile = null;
        let uploadedFileName = null;
        let sessionId = 'session_' + Date.now();

        // ===== æ–‡ä»¶ä¸Šä¼ ç›¸å…³ =====
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');

        dropArea.addEventListener('click', () => fileInput.click());
        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.style.background = '#f8f9ff';
        });
        dropArea.addEventListener('dragleave', () => {
            dropArea.style.background = '';
        });
        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.style.background = '';
            if (e.dataTransfer.files.length > 0) {
                handleFileSelection(e.dataTransfer.files[0]);
            }
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelection(e.target.files[0]);
            }
        });

        function handleFileSelection(file) {
            selectedFile = file;
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            document.getElementById('fileInfo').classList.add('show');
            document.getElementById('uploadBtn').disabled = false;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function clearFile() {
            selectedFile = null;
            fileInput.value = '';
            document.getElementById('fileInfo').classList.remove('show');
            document.getElementById('uploadBtn').disabled = true;
            document.getElementById('uploadProgress').classList.remove('show');
        }

        // ===== æ•°æ®åº“è¿æ¥ =====
        async function testConnection() {
            const formData = new FormData();
            formData.append('uri', document.getElementById('dbUri').value);
            formData.append('userName', document.getElementById('dbUsername').value);
            formData.append('password', document.getElementById('dbPassword').value);
            formData.append('database', document.getElementById('dbDatabase').value);

            try {
                showResponse('connectionResponse', 'æ­£åœ¨æµ‹è¯•è¿æ¥...', false);
                const response = await fetch(`${API_BASE_URL}/backend_connection_configuration`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                showResponse('connectionResponse', data, response.ok);
                if (response.ok && data.status === 'Success') {
                    document.getElementById('extractionStatus').textContent = 'å·²è¿æ¥';
                    document.getElementById('extractionStatus').style.background = '#4caf50';
                    document.getElementById('extractionStatus').style.color = 'white';
                }
            } catch (error) {
                showError('connectionResponse', error.message);
            }
        }

        // ===== æ–‡ä»¶ä¸Šä¼  =====
        async function uploadFile() {
            if (!selectedFile) {
                alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
                return;
            }

            const CHUNK_SIZE = 5 * 1024 * 1024;
            const totalChunks = Math.ceil(selectedFile.size / CHUNK_SIZE);
            const model = document.getElementById('modelSelect').value;

            document.getElementById('uploadProgress').classList.add('show');
            const progressBar = document.getElementById('uploadProgressFill');

            try {
                for (let chunkNumber = 1; chunkNumber <= totalChunks; chunkNumber++) {
                    const start = (chunkNumber - 1) * CHUNK_SIZE;
                    const end = Math.min(chunkNumber * CHUNK_SIZE, selectedFile.size);
                    const chunk = selectedFile.slice(start, end);

                    const formData = new FormData();
                    formData.append('file', chunk, selectedFile.name);
                    formData.append('chunkNumber', chunkNumber);
                    formData.append('totalChunks', totalChunks);
                    formData.append('originalname', selectedFile.name);
                    formData.append('model', model);
                    formData.append('uri', document.getElementById('dbUri').value);
                    formData.append('userName', document.getElementById('dbUsername').value);
                    formData.append('password', document.getElementById('dbPassword').value);
                    formData.append('database', document.getElementById('dbDatabase').value);

                    const response = await fetch(`${API_BASE_URL}/upload`, {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();
                    const progress = Math.round((chunkNumber / totalChunks) * 100);
                    progressBar.style.width = `${progress}%`;
                    progressBar.textContent = `${progress}%`;

                    if (chunkNumber === totalChunks) {
                        showResponse('uploadResponse', data, response.ok);
                        if (response.ok) {
                            uploadedFileName = selectedFile.name;
                            document.getElementById('fileName_extract').value = uploadedFileName;
                        }
                    }
                }
            } catch (error) {
                showError('uploadResponse', error.message);
            }
        }

        // ===== çŸ¥è¯†å›¾è°±æå– =====
        function updateSourceFields() {
            const sourceType = document.getElementById('sourceType').value;
            document.querySelectorAll('[id$="Fields"]').forEach(el => {
                if (el.id.includes('local') || el.id.includes('url') ||
                    el.id.includes('bilibili') || el.id.includes('wiki')) {
                    el.classList.add('hidden');
                }
            });

            if (sourceType === 'local_file') {
                document.getElementById('localFileFields').classList.remove('hidden');
            } else if (sourceType === 'web-url') {
                document.getElementById('urlFields').classList.remove('hidden');
            } else if (sourceType === 'bilibili') {
                document.getElementById('bilibiliFields').classList.remove('hidden');
            } else if (sourceType === 'Wikipedia') {
                document.getElementById('wikiFields').classList.remove('hidden');
            }
        }

        async function extractGraph() {
            const formData = new FormData();
            formData.append('uri', document.getElementById('dbUri').value);
            formData.append('userName', document.getElementById('dbUsername').value);
            formData.append('password', document.getElementById('dbPassword').value);
            formData.append('database', document.getElementById('dbDatabase').value);
            formData.append('model', document.getElementById('extractModel').value);
            formData.append('source_type', document.getElementById('sourceType').value);

            const sourceType = document.getElementById('sourceType').value;
            if (sourceType === 'local_file') {
                formData.append('file_name', document.getElementById('fileName_extract').value);
            } else if (sourceType === 'web-url') {
                formData.append('source_url', document.getElementById('sourceUrl').value);
            } else if (sourceType === 'bilibili') {
                formData.append('source_url', document.getElementById('bilibiliUrl').value);
            } else if (sourceType === 'Wikipedia') {
                formData.append('wiki_query', document.getElementById('wikiQuery').value);
            }

            formData.append('token_chunk_size', document.getElementById('tokenChunkSize').value);
            formData.append('chunk_overlap', document.getElementById('chunkOverlap').value);

            try {
                showResponse('extractResponse', 'æ­£åœ¨æå–çŸ¥è¯†å›¾è°±ï¼Œè¯·ç¨å€™...', false);
                const response = await fetch(`${API_BASE_URL}/extract`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                showResponse('extractResponse', data, response.ok);
                if (response.ok) {
                    addMessage('assistant', 'âœ… çŸ¥è¯†å›¾è°±æå–å®Œæˆï¼ç°åœ¨å¯ä»¥å‘æˆ‘æé—®äº†ã€‚');
                }
            } catch (error) {
                showError('extractResponse', error.message);
            }
        }

        // ===== åå¤„ç†ä»»åŠ¡ =====
        function selectAllTasks() {
            document.getElementById('task_similarities').checked = true;
            document.getElementById('task_fulltext').checked = true;
            document.getElementById('task_consolidation').checked = true;
        }

        function clearTaskSelection() {
            document.getElementById('task_similarities').checked = false;
            document.getElementById('task_fulltext').checked = false;
            document.getElementById('task_consolidation').checked = false;
        }

        async function executePostProcessing() {
            // è·å–é€‰ä¸­çš„ä»»åŠ¡
            const tasks = [];
            if (document.getElementById('task_similarities').checked) {
                tasks.push('materialize_text_chunk_similarities');
            }
            if (document.getElementById('task_fulltext').checked) {
                tasks.push('enable_fulltext_search');
            }
            if (document.getElementById('task_consolidation').checked) {
                tasks.push('graph_schema_consolidation');
            }

            if (tasks.length === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªåå¤„ç†ä»»åŠ¡');
                return;
            }

            try {
                showResponse('postProcessingResponse', 'æ­£åœ¨æ‰§è¡Œåå¤„ç†ä»»åŠ¡ï¼Œè¯·ç¨å€™...', false);

                // ä½¿ç”¨ FormData å‘é€æ‰€æœ‰å‚æ•°
                const formData = new FormData();
                formData.append('tasks', tasks);
                formData.append('uri', document.getElementById('dbUri').value);
                formData.append('userName', document.getElementById('dbUsername').value);
                formData.append('password', document.getElementById('dbPassword').value);
                formData.append('database', document.getElementById('dbDatabase').value);

                const response = await fetch(`${API_BASE_URL}/post_processing`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                showResponse('postProcessingResponse', data, response.ok);

                if (response.ok) {
                    // æ˜¾ç¤ºè¯¦ç»†ç»“æœ
                    if (data.data && data.data.length > 0) {
                        const summary = data.data.map(item => {
                            return `\næ–‡ä»¶: ${item.filename}\n` +
                                   `  - èŠ‚ç‚¹æ•°: ${item.nodeCount || 'N/A'}\n` +
                                   `  - å…³ç³»æ•°: ${item.relationshipCount || 'N/A'}\n` +
                                   `  - å®ä½“èŠ‚ç‚¹: ${item.entityNodeCount || 'N/A'}\n` +
                                   `  - å—èŠ‚ç‚¹: ${item.chunkNodeCount || 'N/A'}`;
                        }).join('\n');

                        addMessage('assistant', `âœ… åå¤„ç†ä»»åŠ¡å®Œæˆï¼\n${summary}`);
                    } else {
                        addMessage('assistant', 'âœ… åå¤„ç†ä»»åŠ¡å®Œæˆï¼');
                    }
                }
            } catch (error) {
                showError('postProcessingResponse', error.message);
            }
        }

        // ===== èŠå¤©åŠŸèƒ½ =====
        function handleChatKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const question = input.value.trim();
            if (!question) return;

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage('user', question);
            input.value = '';

            // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥
            document.getElementById('typingIndicator').classList.add('show');
            document.getElementById('sendBtn').disabled = true;

            try {
                const formData = new FormData();
                formData.append('uri', document.getElementById('dbUri').value);
                formData.append('userName', document.getElementById('dbUsername').value);
                formData.append('password', document.getElementById('dbPassword').value);
                formData.append('database', document.getElementById('dbDatabase').value);
                formData.append('model', document.getElementById('chatModel').value);
                formData.append('question', question);
                formData.append('document_names', uploadedFileName || '');
                formData.append('session_id', sessionId);
                formData.append('mode', document.getElementById('chatMode').value);

                const response = await fetch(`${API_BASE_URL}/chat`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText || 'èŠå¤©è¯·æ±‚å¤±è´¥'}`);
                }

                // å¤„ç†æµå¼å“åº”
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                const loadingElements = new Map(); // è·Ÿè¸ªå·¥å…·åŠ è½½çŠ¶æ€

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const text = decoder.decode(value, { stream: true });
                    const lines = text.split('\n');

                    for (const line of lines) {
                        if (!line.trim()) continue;

                        try {
                            const data = JSON.parse(line);

                            if (data.type === 'assistant' && data.content) {
                                // AI æ¯æ¬¡è¾“å‡ºéƒ½åˆ›å»ºç‹¬ç«‹æ¶ˆæ¯
                                addMessage('assistant', data.content);
                            } else if (data.type === 'tool_call') {
                                // å·¥å…·è°ƒç”¨ä½œä¸ºç‹¬ç«‹æ¶ˆæ¯
                                const toolArgs = JSON.stringify(data.content.args, null, 2);
                                const toolName = data.content.name;
                                const loadingId = `loading_${toolName}_${Date.now()}`;

                                addToolCallMessage(toolName, toolArgs, loadingId);
                                loadingElements.set(toolName, loadingId);
                            } else if (data.type === 'tool_result') {
                                // å·¥å…·ç»“æœä½œä¸ºç‹¬ç«‹æ¶ˆæ¯
                                const result = data.content.result;
                                const toolName = data.content.name;

                                // ç§»é™¤å¯¹åº”çš„åŠ è½½çŠ¶æ€
                                const loadingId = loadingElements.get(toolName);
                                if (loadingId) {
                                    const loadingElement = document.getElementById(loadingId);
                                    if (loadingElement) {
                                        loadingElement.remove();
                                    }
                                    loadingElements.delete(toolName);
                                }

                                addToolResultMessage(toolName, result);
                            } else if (data.type === 'error') {
                                // å¤„ç†é”™è¯¯æ¶ˆæ¯
                                addMessage('assistant', `âŒ é”™è¯¯: ${data.content || 'æœªçŸ¥é”™è¯¯'}`);
                            }
                        } catch (e) {
                            console.error('è§£ææ¶ˆæ¯å¤±è´¥:', e, line);
                            // å¿½ç•¥é JSON è¡Œ
                        }
                    }
                }

            } catch (error) {
                console.error('èŠå¤©é”™è¯¯:', error);
                addMessage('assistant', `âŒ èŠå¤©å‡ºé”™: ${error.message}\n\nè¯·æ£€æŸ¥ï¼š\n1. æ•°æ®åº“è¿æ¥æ˜¯å¦æ­£å¸¸\n2. æ˜¯å¦å·²ä¸Šä¼ å¹¶æå–çŸ¥è¯†å›¾è°±\n3. åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œä¸­`);
            } finally {
                document.getElementById('typingIndicator').classList.remove('show');
                document.getElementById('sendBtn').disabled = false;
            }
        }

        function addMessage(type, content) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = content;

            const metaDiv = document.createElement('div');
            metaDiv.className = 'message-meta';
            metaDiv.textContent = new Date().toLocaleTimeString('zh-CN');

            messageDiv.appendChild(contentDiv);
            messageDiv.appendChild(metaDiv);
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            return contentDiv;
        }

        function updateMessageContent(element, content) {
            element.textContent = content;
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function addToolCallMessage(toolName, toolArgs, loadingId) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message tool';

            const toolCallHtml = `
                <div class="tool-call">
                    <div class="tool-header" onclick="toggleTool(this)">
                        <span class="tool-icon">ğŸ”§</span>
                        <span class="tool-name">${escapeHtml(toolName)}</span>
                        <span class="tool-toggle">â–¼</span>
                    </div>
                    <div class="tool-details" style="display:none;">
                        <pre class="tool-args">${escapeHtml(toolArgs)}</pre>
                    </div>
                </div>
                <div class="tool-loading" id="${loadingId}">
                    <span class="loading-spinner"></span>
                    <span>æ­£åœ¨æ‰§è¡Œ ${escapeHtml(toolName)}...</span>
                </div>
            `;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = toolCallHtml;

            const metaDiv = document.createElement('div');
            metaDiv.className = 'message-meta';
            metaDiv.textContent = new Date().toLocaleTimeString('zh-CN');

            messageDiv.appendChild(contentDiv);
            messageDiv.appendChild(metaDiv);
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function addToolResultMessage(toolName, result) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message tool';

            const isLong = result.length > 200;
            const toolResultHtml = `
                <div class="tool-result">
                    <div class="tool-header" onclick="toggleTool(this)" ${isLong ? '' : 'style="cursor:default;"'}>
                        <span class="tool-icon">ğŸ“Š</span>
                        <span class="tool-name">${escapeHtml(toolName)} ç»“æœ</span>
                        ${isLong ? '<span class="tool-toggle">â–¼</span>' : ''}
                    </div>
                    <div class="tool-details" style="display:${isLong ? 'none' : 'block'};">
                        <pre class="tool-result-content">${escapeHtml(result)}</pre>
                    </div>
                </div>
            `;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = toolResultHtml;

            const metaDiv = document.createElement('div');
            metaDiv.className = 'message-meta';
            metaDiv.textContent = new Date().toLocaleTimeString('zh-CN');

            messageDiv.appendChild(contentDiv);
            messageDiv.appendChild(metaDiv);
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function appendToMessage(element, html) {
            element.innerHTML += html;
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function toggleTool(header) {
            const details = header.nextElementSibling;
            const toggle = header.querySelector('.tool-toggle');
            if (!toggle) return; // çŸ­ç»“æœæ²¡æœ‰ toggle æŒ‰é’®

            if (details.style.display === 'none') {
                details.style.display = 'block';
                toggle.textContent = 'â–²';
            } else {
                details.style.display = 'none';
                toggle.textContent = 'â–¼';
            }
        }

        function clearChat() {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = `
                <div class="message assistant">
                    <div class="message-content">
                        å¯¹è¯å·²æ¸…ç©ºã€‚æˆ‘æ˜¯åŸºäºçŸ¥è¯†å›¾è°±çš„æ™ºèƒ½åŠ©æ‰‹ï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„ï¼ŸğŸš€
                    </div>
                </div>
            `;
            sessionId = 'session_' + Date.now();
        }

        // ===== é€šç”¨åŠŸèƒ½ =====
        function showResponse(elementId, data, isSuccess) {
            const element = document.getElementById(elementId);
            element.classList.remove('hidden', 'response-success', 'response-error');
            element.classList.add(isSuccess ? 'response-success' : 'response-error');
            element.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }

        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            element.classList.remove('hidden', 'response-success', 'response-error');
            element.classList.add('response-error');
            element.innerHTML = `<pre style="color: #721c24;">é”™è¯¯: ${message}</pre>`;
        }

        // åˆå§‹åŒ–
        updateSourceFields();
    </script>
</body>
</html>
